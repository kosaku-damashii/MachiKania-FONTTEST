USEGRAPHIC 9
USECLASS CKNJ16
USEVAR MAXH,MAXW,CHRH,CHRW,CODE,CSR_X,CSR_Y,KU,AREAH,SEL_X
MAXW=SYSTEM(22)
MAXH=SYSTEM(23)
CHRW=16
CHRH=16
KU=$A4
CODE=(KU<<8)+$A1
AREAH=($FE-$A1+1)/(MAXW/CHRW-2)+1
X=0
Y=MAXH-1-CHRH*AREAH
SEL_X=0
CSR_X=0
CSR_Y=SYSTEM(21)-AREAH*2+1 

K=NEW(CKNJ16,"EUC-JP")

GOSUB PRTCHR,KU

COLOR 2
CURSOR CSR_X,CSR_Y
PRINT CHR$($82)+CHR$($82)


WHILE 1
  S=READKEY()
  IF S THEN
    A=(S >> 8) AND $FF
    CURSOR CSR_X,CSR_Y
    PRINT "  "
    IF A=$26 THEN
      CSR_Y=CSR_Y-2
    ELSEIF A=$28 THEN
      CSR_Y=CSR_Y+2
    ELSEIF A=$25 THEN
      CSR_X=CSR_X-2
    ELSEIF A=$27 THEN
      CSR_X=CSR_X+2
    ELSEIF A=$08 THEN
      SEL_X=SEL_X-CHRW
      IF SEL_X < 0 THEN SEL_X=0
      BOXFILL SEL_X,0,SEL_X+CHRW,CHRH,0
    ELSEIF A=$0D THEN
      POINT SEL_X,0
      C$=CHR$(KU)+CHR$($A1+((MAXW/CHRW)-1)*(CSR_Y-(SYSTEM(21)-AREAH*2)-1)/2+CSR_X/2)+CHR$($00)
      K.GPRT(C$,7,0)
      SEL_X=SEL_X+CHRW
    ENDIF

    IF CSR_X < 0 THEN
      CSR_X=SYSTEM(20)-4
    ELSEIF CSR_X >= SYSTEM(20)-2 THEN
      CSR_X=0
    ELSEIF CSR_Y < SYSTEM(21)-AREAH*2+1 THEN
      CODE=CODE-$100
      KU=(CODE >> 8) AND $FF
      IF CODE < $A1A1 THEN
        CODE=$A1A1
        KU=(CODE >> 8) AND $FF
        CSR_Y=SYSTEM(21)-AREAH*2+1
      ELSEIF CODE < $A9A1 THEN
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSEIF CODE < $B0A1 THEN
        CODE=$A8A1
        KU=(CODE >> 8) AND $FF
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSEIF CODE < $F5A1 THEN
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSEIF CODE < $F9A1 THEN
        CODE=$A4A1
        KU=(CODE >> 8) AND $FF
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSE
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ENDIF
    ELSEIF CSR_Y > SYSTEM(21)-1 THEN
      CODE=CODE+$100
      KU=(CODE >> 8) AND $FF
      IF CODE > $FEA1 THEN
        CODE=$FEA1
        KU=(CODE >> 8) AND $FF
        CSR_Y=SYSTEM(21)-1
      ELSEIF CODE < $A9A1 THEN
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-AREAH*2+1
      ELSEIF CODE < $B0A1 THEN
        CODE=$B0A1
        KU=(CODE >> 8) AND $FF
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-AREAH*2+1
      ELSEIF CODE < $F5A1 THEN
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSEIF CODE < $F9A1 THEN
        CODE=$F9A1
        KU=(CODE >> 8) AND $FF
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-1
      ELSE
        GOSUB PRTCHR,KU
        CSR_Y=SYSTEM(21)-AREAH*2+1
      ENDIF
    ENDIF

    COLOR 2
    CURSOR CSR_X,CSR_Y
    PRINT CHR$($82)+CHR$($82)
  ENDIF
WEND

LABEL PRTCHR
VAR A,S
S=ARGS(1)
BOXFILL 0,MAXH-1-CHRH*AREAH,MAXW-1,MAXH-1,0
X=0
REM Y=MAXH-1-CHRH*(($FE-$A1+1)/(MAXW/CHRW-2))
Y=MAXH-1-CHRH*AREAH
A=$A1
DO WHILE A < $FE
  FOR I=0 TO MAXW/CHRW-2
    POINT X+CHRW*I,Y
    C$=CHR$(S)+CHR$(A)+CHR$($00)
    K.GPRT(C$,7,0)
    A=A+1
  NEXT
  X=0
  Y=Y+CHRH 
LOOP
RETURN
